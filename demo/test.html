<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Title</title>
  </head>
  <body>

      <button type="button" onclick="start()">start</button>
    <input type="file" id="file">
    <canvas id="c" height=300></canvas><br>
    <audio id="a" crossOrigin="anonymous" autoplay controls
           >

    <script>
      const input = document.querySelector('#file');
      const a = document.querySelector('audio');
      const c = document.querySelector('canvas');

      input.addEventListener('change', (e) => {
        const file = e.target.files[0];
        const reader = new FileReader()
        reader.readAsDataURL(file);

        // a.addEventListener('canplay', () => start());
        reader.onloadend = e => {
          a.src = e.target.result;
        start();
        }

      });
      function start() {


        var ctx = c.getContext("2d"),                  // canvas context
          actx = new AudioContext(),                 // audio context
          cx = c.width * 0.5, cy = c.height * 0.5,   // center of canvas
          radiusMax = Math.min(cx, cy) - 20,         // circle min/max radii
          radiusMin = radiusMax * 0.1,
          analyzer, srcNode, bquad, fftLen, fft;     // audio nodes and FFT data

        ctx.fillStyle = "#fff";
        ctx.fillText("Loading audio...", 10, 10);

a.play();
        // a.oncanplay = function() {

          if(srcNode) return;

          // link audio element and Web Audio API
          srcNode = actx.createMediaElementSource(a);

          // create filter node
          bquad = actx.createBiquadFilter();
          bquad.type = "lowpass";
          bquad.frequency.value = 250;

          // create FFT analyzer node
          analyser = actx.createAnalyser();
          analyser.fftSize = 256;

          // connect nodes: srcNode (input) -> analyzer -> destination (output)
          srcNode.connect(bquad);
          bquad.connect(analyser);

          // connnect source directly to output
          srcNode.connect(actx.destination);

          // create FFT data buffer
          fftLen = analyser.frequencyBinCount;
          fft = new Uint8Array(fftLen);

          // set up arc look
          ctx.lineWidth = 12;
          ctx.strokeStyle = "#09f";

          ctx.fillStyle = "rgba(0,0,0,0.16)";

          // start visual galore
          render()
        // };

        function render() {

          // clear semi-transparent
          ctx.fillRect(0, 0, c.width, c.height);

          // fill FFT buffer
          analyser.getByteFrequencyData(fft);

          // average data from some bands
          v = (fft[1] + fft[2]) / 512;

          // draw arc using interpolated range with exp. of v
          ctx.beginPath();
          ctx.arc(cx, cy, radiusMin + (radiusMax - radiusMin) * v * v * v * v, 0, 6.28);
          ctx.closePath();
          ctx.stroke();

          // feedback effect
          ctx.drawImage(c, -8, -8, c.width + 16, c.height + 16);

          requestAnimationFrame(render)
        }
      }
    </script>

  </body>
</html>
